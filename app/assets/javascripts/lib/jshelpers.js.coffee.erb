window.handleProcessingPins = (selector) ->
  $(selector).find('.pin-processing').each () ->
    handleSingleProcessingPin( $(this).parents('.pin').first() )

handleSingleProcessingPin = (pin) ->
  url = '<%= Rails.application.routes.url_helpers.processed_pin_path('PIN_ID') %>'.replace('PIN_ID', pin.data('pin-id'))
  
  $.get url, (imgURL) ->
    if (imgURL.length == 0)
      setTimeout (() -> handleSingleProcessingPin(pin)), 1000 + (Math.random * 100)
    else
      pin.find('.pin-processing').remove()
      pin.find('a.ajax.image_link img').attr('src', imgURL).attr('height', 'auto').attr('width', 'auto').css({width: 'auto', height: 'auto'})
      pin.find('.actions').removeClass('processing').find('.processing-note').remove()
      pin.parents('.masonry').masonry('layout')