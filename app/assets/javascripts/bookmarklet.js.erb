//= require templates/bookmarklet/base
//= require templates/bookmarklet/potentials


// TODO - how to not mess with calling page's jquery version?
// TODO - how to wrap template includes in our bigger function to protect it from including page's content?


(function(document, jQuery) {
  // Config
  var popupName = 'ParentPinBookmarklet';
  var cssUrl = '//<%= HOST %>/assets/bookmarklet.css';
  var minJQversion = '1.6.0';
  var desiredJQversion = '1.8.2';
  var minImageWidth = 192;
  var minImageHeight = 150;
  var pinBaseUrl = '//<%= HOST %><%= Rails.application.routes.url_helpers.bookmarklet_popup_path %>';
  var popupHeight = 640;
  var popupWidth = 640;
  
	// check prior inclusion and version
	if (jQuery === undefined || jQuery.fn.jquery < minJQversion) {
		var done = false;
		var script = document.createElement("script");
		script.src = "//ajax.googleapis.com/ajax/libs/jquery/" + desiredJQversion + "/jquery.min.js";
		script.onload = script.onreadystatechange = function(){
			if (!done && (!this.readyState || this.readyState == "loaded" || this.readyState == "complete")) {
				done = true;
				jQuery = window.jQuery;
				initBookmarkletWrapper();
			}
		};
		document.getElementsByTagName("head")[0].appendChild(script);
	} else {
		initBookmarkletWrapper();
	}
  
  // Just to be sure $ is available and not in compatibility mode on the host site
  function initBookmarkletWrapper() {
    (window.ppBookmarklet = function() {
      includeBookmarkletStyles();
      initBookmarklet(jQuery);
    })();
  }
  
  function includeBookmarkletStyles() {
    if ($('link#'+popupName+'CSS').length) return;
    $('head').append('<link href="' + cssUrl + '?r=' + (Math.random() * 9999999) + '" media="all" rel="stylesheet" type="text/css" id="' + popupName + 'CSS" />');
  }
  
  // Close popup if any are open
  function initBookmarklet($) {
    if ($('#'+popupName).length) {
      closeBookmarklet();
      return;
    }
    
    var $popup = $( JST['templates/bookmarklet/base']({popupName: popupName}) ).appendTo( $('body') );
    $popup.on('click', '#ppClose', closeBookmarklet);
    var $content = $popup.find('#ppBookmarkletContent');
    $content.html( JST['templates/bookmarklet/potentials']({images: getPotentialImages()}) );

    // Adjust height to exactly match image
    $('.potentialImage').each(function() {
      var $container = $(this);
      $container.css('height', $container.find('img').height() + 'px');
    });
    $popup.on('click', 'a.potentialImage', switchToPinView);
  }
  
  function closeBookmarklet() {
    $('#'+popupName).fadeOut(function() {
      $(this).remove();
    });
    return false;
  }

  function getPotentials_Images() {
    var allImages = $("img:not('.nonPinnable')");
    var toConsider = [];
    var toReturn = [];
        
    //     TODO -- avoid duplicate images -- if link to larger image, try that first. If dimensions are big enough, remove smaller from the list.
        
    allImages.each(function() {
      var $img = $(this);    
      var imgExt = $img.attr('src').match(/\.\w+?$/);
      var link = $img.parents('a').first().attr('href');

      // If small image linking to larger image with same extension, use larger image instead
      if (link && imgExt) {
        var endsWithSameExtension = new RegExp(imgExt+'$');
        if (link.match(endsWithSameExtension)) {
          toConsider.push( $('<img src='+link+'"/>') );
          return;
        }
      }
      toConsider.push($img);
    });
    
    console.log(toConsider);
    // TODO -- loop over this ...
    
    $.each(toConsider, function() {
      var $img = $(this);
      if (($img.width() >= minImageWidth) && ($img.height() >= minImageHeight)) {
        toReturn.push($img);
      }
    });
    
    
    return toReturn;
  }
  
  // Return list of all sufficiently-large images on this page (excluding .nonPinnable, which will be applied to any images in our bookmarklet)
  function getPotentialImages() {

    getPotentials_Images().map(function(){
      // Collect image information, send it to the template
      var $img = $(this);
      return {
        src:    $img.attr('src'),
        height: $img.attr('height'),
        width:  $img.attr('width'),
        link:   $img.parents('a').first().attr('href')
      };
    });
  }
  
  function ensureDefinedAndLimited(str, limit) {
    if (!str || typeof(str) == 'undefined' || str == 'undefined') return '';
    if (str.length > limit) return str.substr(0, limit) + '...';
    return str;
  }
  
  function switchToPinView(e) {
    e.preventDefault();
    var potential = $(e.currentTarget);
    
    var args = {
      media: potential.find('img').attr('src'),
      title: ensureDefinedAndLimited(document.title, 100),
      description: ensureDefinedAndLimited($("meta[name='description']").attr('content'), 250)
    };
        
    // Set URL to current location, unless image was in a link. Then set URL to the link href, and via to the current URL.
    if (potential.data('link').length) args['url'] = potential.data('link');
    args[ ((args['url'] && args['url'].length) ? 'via' : 'url') ] = window.location + '';
    
    var url = pinBaseUrl + '?' + $.param(args);
    var pinWindow = window.open(url,'pinWindow','height='+popupHeight+',width='+popupWidth+',menubar=no,status=no,toolbar=no,location=no');
    if (window.focus) pinWindow.focus();
    return false;
  }
  
})(document, window.jQuery);